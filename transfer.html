<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>
<title>Add Transfer</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png">

<style>
  html {
    background: #ffffff; /* light fallback */
  }
</style>


<!-- ðŸ”¥ Decide theme BEFORE styles load -->
<script>
  if (localStorage.getItem("theme") === "dark") {
    document.documentElement.setAttribute("data-theme", "dark");
  }
</script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Styles (DO NOT disable any) -->
<link rel="stylesheet" href="styles-light.css">
<link rel="stylesheet" href="styles-dark.css">

</head>

<body class="page">


<button id="themeToggle" class="theme-toggle">ðŸŒ™</button>

<div class="app">

  <div class="header-row">
    <div class="expense-header">New Transfer</div>

    <a
      href="https://docs.google.com/spreadsheets/d/1btzhbKqJhdoWcHs6G3Fsm3fkS22N9EW1QGImdqtjnEU/edit?usp=sharing"
      target="_blank"
      class="icon-btn"
      aria-label="Open Google Sheets"
    >
      <img src="svgs/google-sheets.svg" alt="">
    </a>
  </div>

  <!-- AMOUNT -->
<div class="amount-wrapper">
  <input type="text" id="amount" inputmode="decimal" placeholder="0.00" />
  <div class="amount-label">Amount</div>
</div>


  <div class="form-section">

  <div class="form-group">
    <label>From</label>
    <select id="fromAccount">
      <option>Cash</option>
      <option>GCash</option>
      <option>MariBank</option>
      <option>Maya</option>
      <option>BPI</option>
    </select>
  </div>

  <div class="form-group">
    <label>To</label>
    <select id="toAccount">
      <option>Cash</option>
      <option>GCash</option>
      <option>MariBank</option>
      <option>Maya</option>
      <option>BPI</option>
    </select>
  </div>

  <div class="form-group">
    <div class="amount-label">Transfer Fee</div>
    <input type="text" id="fee" inputmode="decimal" placeholder="0.00" />
  </div>



  <div class="form-group">
    <label>Date</label>
    <input type="date" id="date">
  </div>



  </div>

  <button id="addTransferBtn" class="add-expense-btn">
    Save
  </button>

</div>

<!-- NAVBAR -->
<nav class="bottom-nav">
  <a href="balances.html" class="nav-item">
    <img src="svgs/home-1-svgrepo-com.svg">
    <span>Home</span>
  </a>

  <a href="index.html" class="nav-item">
    <img src="svgs/minus-square-svgrepo-com.svg">
    <span>Expense</span>
  </a>

  <a href="inflow.html" class="nav-item">
    <img src="svgs/add-square-svgrepo-com.svg">
    <span>Inflow</span>
  </a>

  <a class="nav-item active">
    <img src="svgs/refresh-square-svgrepo-com-filled.svg">
    <span>Transfer</span>
  </a>
</nav>


<script src="theme-engine.js"></script>
<script>  

function formatNumberWithCommas(value) {
  if (!value) return "";

  const clean = value.replace(/,/g, "");
  if (isNaN(clean)) return value;

  const parts = clean.split(".");
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  return parts.join(".");
}

const amountInput = document.getElementById("amount");
const feeInput = document.getElementById("fee");

function attachMoneyFormatter(input) {
  input.addEventListener("input", (e) => {
    const el = e.target;
    const caretPos = el.selectionStart;

    const digitsBefore = el.value
      .slice(0, caretPos)
      .replace(/[^0-9]/g, "").length;

    const raw = el.value.replace(/,/g, "");
    if (isNaN(raw)) return;

    const formatted = formatNumberWithCommas(raw);
    el.value = formatted;

    let pos = 0;
    let digitsSeen = 0;

    while (pos < formatted.length) {
      if (/\d/.test(formatted[pos])) {
        digitsSeen++;
        if (digitsSeen === digitsBefore) {
          pos++;
          break;
        }
      }
      pos++;
    }

    el.setSelectionRange(pos, pos);
  });

  input.addEventListener("blur", () => {
    const raw = input.value.replace(/,/g, "");
    const num = Number(raw);

    if (isNaN(num)) return;

    // Did the user actually type a decimal?
    const hasDecimal = raw.includes(".");

    input.value = num.toLocaleString(undefined, {
      minimumFractionDigits: hasDecimal ? 0 : 0,
      maximumFractionDigits: 2
    });
  });
}

attachMoneyFormatter(amountInput);
attachMoneyFormatter(feeInput);


const fromEl = document.getElementById("fromAccount");
const toEl = document.getElementById("toAccount");


const PENDING_KEY = "pendingTransfers";



function applyLocalTransfer(from, to, amount) {
  const raw = localStorage.getItem("account_balances");
  if (!raw) return;

  const balances = JSON.parse(raw);

  balances.forEach(b => {
    if (from && b.account === from) b.balance -= amount;
    if (to && b.account === to) b.balance += amount;
  });

  localStorage.setItem("account_balances", JSON.stringify(balances));
}


function getPending() {
  return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]");
}

function setPending(list) {
  localStorage.setItem(PENDING_KEY, JSON.stringify(list));
}

async function submitTransaction(payload) {
  if (!payload || !payload.type) {
    console.warn("Invalid payload, not queued:", payload);
    return;
  }

  const pending = getPending();
  pending.push({
    id: crypto.randomUUID(),
    payload: structuredClone(payload),
    timestamp: Date.now()
  });

  setPending(pending);
  trySyncPending();
}

function getAccountBalance(accountName) {
  const raw = localStorage.getItem("account_balances");
  if (!raw) return 0;

  const balances = JSON.parse(raw);

  const match = balances.find(
    b => b.account.toLowerCase() === accountName.toLowerCase()
  );

  return match ? Number(match.balance) : 0;
}

function getAvailableBalance(account) {
  return getAccountBalance(account);
}

let syncing = false;

async function trySyncPending() {
  if (!navigator.onLine || syncing) return;

  syncing = true;

  try {
    const pending = getPending();
    if (!Array.isArray(pending) || pending.length === 0) return;

    const remaining = [];
    let didSync = false;

    for (const item of pending) {
      try {
        const payload = item?.payload;
        if (!payload) throw new Error("Invalid payload");

        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Network error");

        const json = await res.json();
        if (json.status !== "success") {
          throw new Error(json.message || "Server rejected payload");
        }

        didSync = true;

      } catch (err) {
        console.warn("Sync failed, will retry:", err);
        remaining.push(item);
      }
    }

    setPending(remaining);

    if (didSync) {
        // ðŸ”¥ mark global data change
        localStorage.setItem("data_dirty", "1");

        // ðŸ”¥ clear client caches
        localStorage.removeItem("recent_transactions_cache");
      }


  } finally {
    syncing = false;
  }
}


window.addEventListener("online", trySyncPending);


/* ===== DATE DEFAULT ===== */
const dateInput = document.getElementById("date");

const today = new Date();
today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
const todayISO = today.toISOString().slice(0, 10);
dateInput.value = todayISO;

/* ===== TOAST ===== */
function showToast(message, type = "success") {
  const container = document.getElementById("toastContainer");

  const toast = document.createElement("div");
  toast.className = `toast toast-${type}`;

  toast.innerHTML = `
    <div class="toast-icon">
      ${type === "success" ? "âœ“" : "!"}
    </div>
    <div class="toast-text">
      <div class="toast-title">
        ${type === "success" ? "Saved" : "Warning"}
      </div>
      <div class="toast-message">${message}</div>
    </div>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = "toast-out 0.25s ease forwards";
    setTimeout(() => toast.remove(), 250);
  }, 2500);
}

/* ===== GOOGLE SHEETS SUBMIT ===== */
const scriptURL =
"https://script.google.com/macros/s/AKfycbx0j7hBNOI9P_zceaZeLrkypGOXP5s7Emk0GqOfUiNns1K6kEq0Xy2DJR00BVuEejw/exec";

const addBtn = document.getElementById("addTransferBtn");

addBtn.onclick = () => {
  if (addBtn.disabled) return;

  const amountEl = document.getElementById("amount");
  const fromEl = document.getElementById("fromAccount");
  const toEl = document.getElementById("toAccount");
  const feeEl = document.getElementById("fee");

  const fromVal = fromEl.value.trim();
  const toVal = toEl.value.trim();
  const dateVal = dateInput.value;


  // required fields first
  if (!amountEl.value || !fromVal || !toVal || !dateVal) {
    showToast("Please complete the form", "warning");
    return;
  }

  // parse numbers (comma-safe)
  const amountNum = Number(amountEl.value.replace(/,/g, ""));
  const feeNum = Number(feeEl.value.replace(/,/g, "")) || 0;

  // validate amount
  if (isNaN(amountNum) || amountNum <= 0) {
    showToast("Please complete the form", "warning");
    return;
  }

  // validate fee
  if (feeNum < 0) {
    showToast("Fee cannot be negative", "warning");
    return;
  }

  // accounts must differ
  if (fromVal === toVal) {
    showToast("Accounts must be different", "warning");
    return;
  }

  // balance check (amount + fee)
  const available = getAvailableBalance(fromVal);

  if (amountNum + feeNum > available) {
    showToast(
      `Not enough funds (â‚±${available.toFixed(2)})`,
      "warning"
    );
    return;
  }

  const transferTxId = crypto.randomUUID();
  const feeTxId = crypto.randomUUID();



  addBtn.disabled = true;

  submitTransaction({
    txId: transferTxId,
    type: "transfer",
    date: dateVal,
    fromAccount: fromVal,
    toAccount: toVal,
    amount: amountNum,
    fee: feeNum // ðŸ‘ˆ INCLUDED HERE
  });


  localStorage.setItem("data_dirty", "1");


  // âœ… OPTIMISTIC LOCAL UPDATE
  applyLocalTransfer(fromVal, toVal, amountNum);

  if (feeNum > 0) {
    applyLocalTransfer(fromVal, null, feeNum);
  }



  Object.keys(sessionStorage)
    .filter(k => k.startsWith("dashboard_"))
    .forEach(k => sessionStorage.removeItem(k));

  if (navigator.onLine) {
    showToast("Transfer saved âœ“", "success");
  } else {
    showToast("Saved offline â³", "warning");
  }

  // Clear fields
  amountEl.value = "";
  feeEl.value = "";
  fromEl.selectedIndex = 0;
  toEl.selectedIndex = 0;

  if (navigator.vibrate) navigator.vibrate(40);

  setTimeout(() => {
    addBtn.disabled = false;
  }, 400);
};


window.addEventListener("online", () => {
  trySyncPending();
});

requestAnimationFrame(() => {
  document.body.classList.add("page-ready");
});


</script>

<div id="toastContainer" class="toast-container"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
<script>
  firebase.initializeApp({
    apiKey: "AIzaSyBn2kufYDw1It3d-yuf351ApSv54w_57Gk",
    authDomain: "spendr-39376.firebaseapp.com",
    projectId: "spendr-39376"
  });
</script>

<script src="auth-guard.js"></script>


</body>
</html>
